---
# Created from information on https://kodi.wiki/view/Linux

- name: Ensure RpmFusion-free repository is installed
  include_role:
    name: jgoutin.home.rpmfusion
  vars:
    rpmfusion_free: true

- name: Ensure Kodi user is present
  user:
    name: kodi

- name: Ensure Kodi and its dependencies are installed
  dnf:
    state: present
    name:
      - "@base-x"
      - kodi
      - kodi-eventclients
      - kodi-inputstream-adaptive
  retries: 10
  delay: 1
  register: _
  until: _ is successful

- name: Ensure AMD GPU drivers are installed
  dnf:
    state: present
    name: xorg-x11-drv-amdgpu
  retries: 10
  delay: 1
  register: _
  until: _ is successful
  when: kodi_gpu_vendor == 'amd'

- name: Ensure LIRC is installed
  dnf:
    state: present
    name: lirc
  retries: 10
  delay: 1
  register: _
  until: _ is successful
  when: kodi_ir_remote | bool

- name: Ensure LIRC service is started and enabled at boot
  systemd:
    name: lircd
    state: started
    enabled: true
  when: kodi_ir_remote | bool

- name: Ensure Kodi userdata directory is present
  file:
    path: /home/kodi/.kodi/userdata
    state: directory
    owner: kodi
    group: kodi

- name: Ensure Kodi exit button is disabled
  copy:
    src: advancedsettings.xml
    dest: /home/kodi/.kodi/userdata/advancedsettings.xml
    owner: kodi
    group: kodi

- name: Ensure Unzip is installed
  # Required by "unarchive" following step
  dnf:
    state: present
    name: unzip
  retries: 10
  delay: 1
  register: _
  until: _ is successful
  when: kodi_restore_profile is defined

- name: Ensure Kodi profile is restored
  unarchive:
    src: "{{ kodi_restore_profile }}"
    dest: /home/kodi/.kodi
    owner: kodi
    group: kodi
    creates: /home/kodi/.kodi/userdata/profiles.xml
  when: kodi_restore_profile is defined

- include_tasks: firewall.yml

- include_tasks: autostart.yml
