---

- name: Ensure PHP and its modules are installed from Fedora repository
  ansible.builtin.dnf:
    state: present
    name: "{{ ['php', 'php-common', 'php-fpm', 'php-opcache', ['php'] |
           product(php_modules) | map('join', '-') | list] | flatten }}"
    install_weak_deps: false
  retries: 10
  delay: 1
  register: _
  until: _ is successful

- name: Ensure PHP site configuration is present
  ansible.builtin.template:
    src: site.ini.j2
    dest: "/etc/php.d/99-{{ php_fpm_site }}.ini"

- name: Ensure PHP security hardening configuration is present
  ansible.builtin.template:
    src: hardening.ini.j2
    dest: /etc/php.d/90-hardening.ini

- name: Ensure PHP-FPM logs go to the journal
  ansible.builtin.lineinfile:
    path: /etc/php-fpm.conf
    regexp: '^error_log'
    line: 'error_log = syslog'

- name: Ensure PHP-FPM site configuration is present
  ansible.builtin.template:
    src: php-fpm.conf.j2
    dest: "/etc/php-fpm.d/{{ php_fpm_site }}.conf"

- name: Ensure PHP-FPM default site is absent
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /etc/php-fpm.d/www.conf
    - /etc/nginx/conf.d/php-fpm.conf
    - /etc/nginx/default.d/php.conf
    - /etc/httpd/conf.d/php.conf

- name: Ensure PHP-FPM service parent directory is present
  ansible.builtin.file:
    path: /etc/systemd/system/php-fpm.service.d
    state: directory

- name: Ensure PHP-FPM service configuration is present
  ansible.builtin.template:
    src: php-fpm_service.conf.j2
    dest: /etc/systemd/system/php-fpm.service.d/php-fpm.conf

- name: Ensure Fail2ban directory is present
  ansible.builtin.file:
    path: /etc/fail2ban/jail.d/
    state: directory

- name: Ensure Fail2ban is configured
  ansible.builtin.copy:
    src: php.local
    dest: /etc/fail2ban/jail.d/php.local

- name: Ensure PHP-FPM service is enabled at boot
  ansible.builtin.systemd:
    name: php-fpm
    enabled: true
