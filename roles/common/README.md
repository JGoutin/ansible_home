# Common Ansible Role

![Ansible Role: "jgoutin.home.common"](https://github.com/JGoutin/ansible_home/workflows/Ansible%20Role:%20%22jgoutin.home.common%22/badge.svg)

## Description

This role initializes a new host by performing some common configuration tasks.

### Features

Configure:
* Installs SSH authorized key.
* Sets admin user password.
* Configures DNS servers with DNSSEC and "DNS over TLS" support.
* Configures NTP servers with NTS support.
* Sets Grub timeout.
* Configures DNF proxy, weak dependencies, parallel downloads.
* Enables DNF auto-updates (With auto-restart).
* Sets up NFS and CIFS/SMB shares.
* Sets up `root` user mail redirection with SMTP relay on an external server.
* Installs custom CA certificates.

Security:
* Enables Fail2ban SSH jail.
* Works with SElinux enforced.
* Applies some extra OS and SSH hardening.
* Restricts SSH accesses using firewall.

## Variables

### Optional

| Name           | Default Value | Description                        |
| -------------- | ------------- | -----------------------------------|
| `common_admin_password`| | If specified, Set this password to the current remote user. (Must be a hashed password. Can be generated using `mkpasswd --method=sha-512`)
| `common_ca_certificates`| | If specified, CA certificates to install in the system CA trust store. Must be a list of local path to PEM or DER formatted certificates.
| `common_dnf_automatic_restart`| true | If `true`, restart the host if required when performing DNF automatic updates.
| `common_dnf_fastestmirror`| false | If `true`, If enabled a metric is used to find the fastest available mirror. This is often dynamically generated by the server to provide the best download speeds and enabling `fastestmirror` overrides this.
| `common_dnf_install_weak_deps`| false | If `"true"`, configure DNF to install weak dependencies.
| `common_dnf_keepcache`| false | If `"true"`, configure DNF to keep the package cache.
| `common_dnf_proxy`| | URL of a proxy server to connect through The expected format of this option is `<scheme>://<ip-or-hostname>[:port]`. If you configured another host with the [**squid**](../squid/README.md) role, you may set this value to `http://<squid-host-ip-or-hostname>:<squid-port>`.
| `common_dnf_proxy_auth_method`| | If the proxy requires authentication, the authentication method to use.
| `common_dnf_proxy_password`| | If the proxy requires authentication, the password to use.
| `common_dnf_proxy_username`| | If the proxy requires authentication, the username to use.
| `common_dns_over_tls`| `opportunistic` | Enable DNS over TLS. `"yes"` is recommended if DNS server support DNS over TLS because opportunistic mode is more vulnerable. `"no"` to enforce classical unencrypted DNS.
| `common_dns_servers`| | Space-separated list of DNS servers to use, if not set will use the default value generally provided by the DHCP server. If `common_dns_over_tls` is set to `"yes"`, it is recommended to servers values to `address#server_name` to allow certificate validation.
| `common_dns_servers_fallback`| `"1.1.1.1 9.9.9.9 1.0.0.1 149.112.112.112 2606:4700:4700::1111 2620:fe::fe 2606:4700:4700::1001 2620:fe::9"` | Space-separated list of fallback DNS servers to use. The default use Cloudflare and Quad9 DNS servers (Google is replaced for privacy reason).
| `common_dnssec`| | If `"yes"`, enforce DNSSEC validation locally, else use default configuration. The DNS server must support DNSSEC.
| `common_fail2ban_action` | `%(action_mwl)s` | Fail2ban default action. By default, ban user and send mail with detailed logs to root.
| `common_grub_auto_hide`| false | If `true` configure Grub to auto-hide.
| `common_grub_hidden_timeout`| 0 | Grub hidden timeout to set.
| `common_grub_timeout`| 1 | Grub timeout to set.
| `common_hostname`| | If specified, set hostname.
| `common_mail_smtp_host`| | SMTP server host.
| `common_mail_smtp_inet_interfaces`| `127.0.0.1` | Interface from where accept SMTP requests. By default, localhost only. Only if `common_mail_smtp_host` is specified.
| `common_mail_smtp_password`| | Password of the `common_mail_relay_user` user on the SMTP server. Only if `common_mail_smtp_host` is specified.
| `common_mail_smtp_port`| 465 | SMTP server port to use, can be: 25 (SMTP), 465 (SMTPS), 587 (SMTP-Submission). Only if `common_mail_smtp_host` is specified.
| `common_mail_smtp_user`| | User to authenticate on the SMTP server, if specified enable SMTP authentication. Only if `common_mail_smtp_host` is specified.
| `common_mail_smtp_tls`| `TLS` | Security mode to use. Possible values are `TLS` (For SMTPS) or `STARTTLS` (for SMTP/SMTP-Submission).
| `common_mail_smtp_send_to`| | If specified, redirect all root mails to the specified email address.
| `common_nfs_mount`| | If specified, mount specified NFS shares. Must be a list of mapping (one per share to mount) with keys: `path` (mount point path), `src` (share to mount), `opts` (optional, mount options, see fstab(5)), `owner` (optional, user owning the mount), `group` (optional, group owning the mount), `mode` (optional, permission mode) , `state` (optional, `present` if require to only add it to `/etc/fstab` without applying it now).
| `common_ntp_server`| | If specified, configure Chrony to use the specified NTP server.
| `common_nts`| false | If `true`, configure Chrony to enable NTS (Network Time Security). The server specified by `common_ntp_server` must support NTS.
| `common_os_hardening`| true | If `true`, run OS hardening role from Dev-Sec.
| `common_smb_mount`| | If specified, mount specified CIFS/SMB shares. The value format is identical to `common_nfs_mount`.
| `common_ssh_authorized_key`| | If specified, add the specified SSH public key to `~/.ssh/authorized_keys`. If `common_ssh_hardening` is set to `true`, this also disable password authentication. (A key can be generated using `ssh-keygen -t ed25519`)
| `common_ssh_hardening`| true | If `true`, set an hardened configuration to the SSH server.
| `common_dnf_sslcacert`| | If specified, file containing the certificate authorities to verify SSL certificates. If not specified, use system defaults. Can be used to specify proxy certificate when used with `common_dnf_proxy`.
| `common_trusted_firewalld_source`| | If specified, configure Firewalld to authorize SSH access only from the specified sources list in CIDR notation (`["192.168.1.10/32", "192.168.1.0/24", "2001:db8:1234:5678::/64"]`, ...).

## Example Playbook

```yaml
---
- hosts: all
  become: true
  force_handlers: true  # See known issues
  collections:
    - jgoutin.home
  roles:
    - common
  vars:
    common_ssh_authorized_key: ssh-ed25519 XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
    common_ntp_server: 192.168.1.1
    common_trusted_firewalld_source: 192.168.1.10/32
```

## Known issues

### Ansible dependencies are not cleaned on failure

Some modules and sub-roles of this role require to install some packages on
the host to work. Since these packages are not required once the Ansible play is
done, this role provides handlers to clean up these packages.

In case of failure during the Ansible play, handlers are not applied and
packages are not cleaned up.

To avoid this issue and ensure the clean up is performed, add 
`force_handlers: true` in the playbook.

### Failure with `common_admin_password` variable

When using the `common_admin_password` variable, the playbook may fail on the
first step that follow `Ensure current user password is set` with the message
`Incorrect sudo password`. 

In this case, simply re-run the playbook and enter the new password when asked 
by Ansible (`BECOME password`).

If the failure is an issue in complex playbook, do not use this variable to set
the password.
